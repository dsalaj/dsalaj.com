---
layout: post
title:  "How to migrate binary bloat out of git repository"
date:   2020-10-25 00:00:00 +0100
---

<div class="page-body"><p id="907bc591-58b8-48fe-91c9-bfb7e0d06966" class=""><strong>The situation:</strong> A project has several binaries that need to be tracked and versioned along with the code. The binaries are small enough and rarely change, so versioning them directly in git is appropriate.</p><p id="2fee7b63-0896-4010-9121-a47da3d687af" class="">That was some months ago, and in the meantime, the project evolved, binaries grew and changed. Now you're left with a bloated repository of multiple gigabytes that takes a long time to clone. This is significantly slowing down the CI pipeline and it's time to fix it.</p><h2 id="6a23a05c-f86a-44fc-8c27-1a6fd0debdec" class="">Dealing with symptoms directly</h2><p id="4d799a62-5fcf-48b8-b398-24de358368ae" class="">There are many options to solve this problem, all with unique pros and cons. The simplest solution is dealing only with problematic symptoms like slow CI pipeline. This can be overcome with one of the following:</p><ul id="a4d928e3-99ad-4c47-8e1e-00b7fe1b5ea9" class="bulleted-list"><li>Shallow clone <code>git clone --depth 1 URL</code>: Limiting the depth of the clone means that the history is not pulled. </li></ul><ul id="bbad9cea-fc88-4976-bd08-5786bcaeb16e" class="bulleted-list"><li>Clone without binary files <code>git clone --filter=blob:none URL</code>: The filter option is more powerful and can be used filter only specific files that meet specific criteria. See <a href="https://github.com/git/git/blob/d98273ba77e1ab9ec755576bc86c716a97bf59d7/Documentation/rev-list-options.txt#L869">docs</a>.</li></ul><ul id="ac2c38f0-fc62-4ded-be0f-e3410dfb99c3" class="bulleted-list"><li>Finally, if the large binary file size is not your problem but the large number of files, you should look into <code>git sparse-checkout</code>. See <a href="https://git-scm.com/docs/git-sparse-checkout">docs</a>.</li></ul><p id="42b388e0-b311-4a54-8629-847c1966834f" class="">But sometimes these workarounds are not enough and you need to rewrite the repo history. Below I will discuss the two solutions that should cover most of the usecases. The first option is  migrating to the <code>git lfs</code>. The second option is pruning the binaries from the repo history using <code>git filter-repo</code> and versioning the binaries in a separate versioning system.</p><h2 id="95da721f-0685-4fd3-b43c-7862ef86cb85" class="">Migrating to <code>git lfs</code></h2><p id="2f6b6dd0-0b0d-4183-bb39-00efca470d21" class="">The main advantage of the migration to <code>git lfs</code> is that the repo history is left intact and no information is lost. This method is recommended when the binaries are really tightly coupled with the code. This is easily done with the following steps:</p><ul id="7a4486db-1bb5-4f5e-bb14-8302fe5b5d7e" class="bulleted-list"><li>Install the git-lfs using this <a href="https://github.com/git-lfs/git-lfs/wiki/Installation">guide</a> or in conda like so:
<code>conda install -c conda-forge git-lfs</code></li></ul><ul id="136e92fe-b98f-40ec-990b-4c213d4a09cb" class="bulleted-list"><li>In your repo, run: <code>git lfs install</code></li></ul><ul id="c37e7873-1352-4e38-9276-4ed2bfa38eb8" class="bulleted-list"><li>Rewrite history. For example migrating all bz2 files:
<code>git lfs migrate import --include-ref=master --include="*.bz2"</code></li></ul><p id="5f882e5c-d19d-459f-9677-eb3f7f128e09" class="">For more details on how to match your usecase see <a href="https://github.com/git-lfs/git-lfs/wiki/Tutorial#migrating-existing-repository-data-to-lfs">this guide</a>.</p><p id="6095bb85-e0ca-484d-82f8-869c3867f3e7" class="">The downside of using <code>git lfs</code> is that it adds more complexity to the workflow of developers. Decisions need to be made: Which files are to be versioned with git and which with <code>git lfs</code>? Do you decide based on the file size or the file format/extension? The <code>.gitattributes</code> file needs to be maintained etc.</p><p id="27da68da-cd07-4535-8c4f-60b5f5c71462" class="">You get the gist, there is overhead and nobody likes overhead. But if the binary files are really tightly coupled with the code and need to be version, this is the way to go.</p><h2 id="3b7518d8-e554-4a14-a38b-93a34c4caaa9" class="">Pruning and migrating to out of git</h2><p id="fc89422d-550b-4a9a-9200-c6f9b104e10f" class="">When the binaries are not tightly coupled with the code there is another solution: simply prune away all the binary files from the repo history and version them in a separate, more appropriate system.</p><p id="6d57c9d1-ebdf-4313-b89d-492fc83326a2" class="">The pruning part is simple thanks to the amazing <a href="https://github.com/newren/git-filter-repo"><code>git filter-repo</code></a> tool. For example, pruning away all the binary files larger than 10 MB can be done using the <a href="https://docs.gitlab.com/ee/user/project/repository/reducing_the_repo_size_using_git.html#repository-cleanup">guide from GitLab</a>. For more elaborate cases please refer to the official <a href="https://htmlpreview.github.io/?https://github.com/newren/git-filter-repo/blob/docs/html/git-filter-repo.html#EXAMPLES">documentation with examples</a>.</p><p id="f4cc1de1-b07e-40c7-9ce7-61d0622baee9" class="">After the pruning, your repo should be very lean, and you are free to version or track the binaries outside of git. For example, in the project I was working on the <a href="https://mlflow.org/"><code>mlflow</code></a> was the appropriate tool we decided on after some trial period. Using the <code>mlflow</code> <a href="https://mlflow.org/docs/latest/python_api/index.html">Python API</a> it was easy to track any artifacts and results along with the meta-data which matched the needs of the project well.</p><p id="03957dad-c639-4d19-b6dd-c83bc9bd6390" class="">The obvious downside is that you lose the history of the binary files. This was the trade-off we were willing to take as the history of the binary files was not very valuable, and we still had access to it in the backups of the repo we made before the prune.</p><p id="e8719630-30f4-47b2-8663-407561572c8d" class="">
</p><p id="76ab4e36-2b97-4d4e-94dd-fd399c6d71a0" class="">Hope this was helpful and you were able to get some useful pointers and links that will help with your git endeavors. Let me know if you found a different solution. Cheers! üçª</p></div>
